<div class="main">
	<div class="container">

		<h2 class="border-bottom border-white mb-4"><%= @mission.title %> <span class="h5">#<%= @mission.id %></span></h2>

		<% if user_signed_in? %>
			<% if @mission.admins.include?(current_user) || @mission.user == current_user %>
				<div class="row">
					<div class="col-md-3 col-sm-6 mb-4">
						<%= link_to 'ミッションを編集', edit_mission_path(@mission), :style=>"width:100%;", :class => 'btn page-link text-dark d-inline-block' %>
					</div>
					<div class="col-md-3 col-sm-6 mb-4">
						<%= link_to "ミッションを削除", @mission, method: :delete, data: {confirm: "本当に削除しますか？"}, :style=>"width:100%;", :class => 'btn page-link text-dark d-inline-block' %>
					</div>
					<div class="col-md-3 col-sm-6 mb-4">
						<%= link_to '参加者を追加', mission_add_participant_path(@mission), :style=>"width:100%;", :class => 'btn page-link text-dark d-inline-block' %>
					</div>
					<div class="col-md-3 col-sm-6 mb-4">
						<%= link_to '管理者を追加', mission_add_admin_path(@mission), :style=>"width:100%;", :class => 'btn page-link text-dark d-inline-block' %>
					</div>
				</div>
			<% end %>
			<% if not (@mission.participants.include?(current_user) || @mission.user == current_user) %>
				<%= link_to '参加', mission_add_me_path(@mission), :class => 'btn btn-primary mb-4' %>
			<% end %>
		<% end %>

		<div class="card mb-4">
			<div class="card-header">
				ミッション概要
			</div>
			<div class="card-body">
				<p class="card-text"><%= @mission.description %></p>
			</div>
		</div>

		<div class="card mb-4">
			<div class="card-header">
				ミッション管理者
			</div>
			<div class="card-body">
				<% @mission.admins.each do |admin| %>
					<p admin_id="<%= admin.id %>">
						<% if @mission.admins.include?(current_user) || @mission.user == current_user %>
							<span class="delete_admin" admin_id="<%= admin.id %>">X</span>
						<% end %>
						<%= admin.name %>
					</p>
				<% end %>
			</div>
		</div>

		<div class="card mb-4">
			<div class="card-header">
				ミッション参加者
			</div>
			<div class="card-body">
				<% @mission.participants.each do |participant| %>
					<p participant_id="<%= participant.id %>">
						<% if @mission.admins.include?(current_user) || @mission.user == current_user || current_user == participant %>
							<span class="delete_mission_participant" participant_id="<%= participant.id %>">X</span>
						<% end %>
						<%= participant.name %>
					</p>
				<% end %>
			</div>
		</div>
		<div class="panel panel-info mb-4">
			<div class="panel-body tree">
				<div id="chart-container"></div>
				<input type="hidden" id="selected-node">
			</div>
		</div>
	</div>
</div>

<!-- DetailTask -->
<div class="modal fade" id="DetailTask" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">タスクの編集 #<span id="DetailTaskID"></span>
					<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img class="ccby-license" alt="クリエイティブ・コモンズ・ライセンス" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/80x15.png" /></a>
				</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form>
					<div class="form-group">
						<label for="DetailTaskTitle" class="col-form-label">タスク名 <span style="color: red">(必須)</span></label>
						<input id="DetailTaskTitle" type="text" class="form-control" value="" required>
					</div>
					<div class="form-group">
						<label for="DetailTaskDescription" class="col-form-label">概要</label>
						<textarea id="DetailTaskDescription" class="form-control" rows="3"></textarea>
					</div>
					<div class="form-group input-group date datepicker">
						<label for="DetailTaskDeadline" class="col-form-label">締め切り</label>
						<div class="input-group date" id="datetimepickerDetailTaskDeadline" data-target-input="nearest">
							<input id="DetailTaskDeadline" type="text" class="form-control datetimepicker-input" data-target="#datetimepickerDetailTaskDeadline"/>
							<div class="input-group-append" data-target="#datetimepickerDetailTaskDeadline" data-toggle="datetimepicker">
								<div class="input-group-text"><i class="fa fa-calendar"></i></div>
							</div>
						</div>
					</div>
					<div class="form-group">
						<label for="DetailTaskStatus" class="col-form-label">状況</label>
						<select id="DetailTaskStatus" class="form-control">
							<option value="todo">未着手</option>
							<option value="doing">進行中</option>
							<option value="done">完了</option>
							<option value="cancel">取りやめ</option>
						</select>
					</div>
					<div class="form-group">
						<label for="DetailTaskNotify" class="col-form-label">公開範囲</label>
						<select id="DetailTaskNotify" class="form-control">
							<option value="own">個人的構想</option>
							<option value="organize">組織内限定</option>
							<option value="publish">外部公開</option>
							<option value="lod">LOD (CC BY)</option>
						</select>
					</div>
				</form>
				<h4>参加者</h4>
				<ul id="TaskParticipants"></ul>
				<hr>
				<h4>タグ</h4>
				<ul id="TaskTags"></ul>
			</div>
			<% if user_signed_in? %>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">閉じる</button>
					<button type="button" id="ToParticipate" class="btn btn-light btn-sm" data-dismiss="modal">タスクへ参加</button>
					<button type="button" id="ToAddChild" class="btn btn-primary btn-sm" data-dismiss="modal">子タスクを追加</button>
					<button type="button" id="ToDeleteTask" class="btn btn-danger btn-sm" data-dismiss="modal">削除</button>
					<button type="button" id="ChangeDetail" class="btn btn-success btn-sm" data-dismiss="modal">変更</button>
				</div>
			<% end %>
		</div>
	</div>
</div>

<!-- DeleteTask -->
<div class="modal fade" id="ConfirmDelete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">タスクの削除</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form>
					<div class="form-group">
						本当に以下のタスクを削除しますか？
					</div>
					<div class="form-group">
						<label for="exampleInputEmail1">タスク名</label>
						<p id="DeleteTaskTitle" style="color: red"></p>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">閉じる</button>
				<button type="button" id="DeleteTask" class="btn btn-danger" data-dismiss="modal">タスクを削除する</button>
			</div>
		</div>
	</div>
</div>

<!-- AddTask -->
<div class="modal fade" id="AddTask" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">子タスクの追加</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form>
					<div class="form-group">
						<label for="AddTaskTitle" class="col-form-label">タスク名 <span style="color: red">(必須)</span></label>
						<input id="AddTaskTitle" type="text" class="form-control" required>
					</div>
					<div class="form-group">
						<label for="AddTaskDescription" class="col-form-label">概要</label>
						<textarea id="AddTaskDescription" class="form-control" rows="3"></textarea>
					</div>
					<div class="form-group">
						<label for="AddTaskDeadline" class="col-form-label">締め切り</label>
						<div class="input-group date" id="datetimepickerAddTaskDeadline" data-target-input="nearest">
							<input id="AddTaskDeadline" type="text" class="form-control datetimepicker-input" data-target="#datetimepickerAddTaskDeadline"/>
							<div class="input-group-append" data-target="#datetimepickerAddTaskDeadline" data-toggle="datetimepicker">
								<div class="input-group-text"><i class="fa fa-calendar"></i></div>
							</div>
						</div>
					</div>
					<div class="form-group">
						<label for="AddTaskStatus" class="col-form-label">状況</label>
						<select id="AddTaskStatus" class="form-control">
							<option value="todo" selected>未着手</option>
							<option value="doing">進行中</option>
							<option value="done">完了</option>
							<option value="cancel">取りやめ</option>
						</select>
					</div>
					<div class="form-group">
						<label for="AddTaskNotify" class="col-form-label">公開範囲</label>
						<select id="AddTaskNotify" class="form-control">
							<option value="own" selected>個人的構想</option>
							<option value="organize">組織内限定</option>
							<option value="publish">外部公開</option>
							<option value="lod">LOD (CC BY)</option>
						</select>
					</div>
				</form>
			</div>
			<% if user_signed_in? %>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">閉じる</button>
					<button type="button" id="AddChild" class="btn btn-primary" data-dismiss="modal">追加する</button>
				</div>
			<% end %>
		</div>
	</div>
</div>

<script>
	const mission_id = <%= @mission.id %>;

	function date_format2rails(datestring){
		try {
			return moment(datestring,'MM/DD/YYYY HH:mm').utc().format();
		}
		catch {
			return datestring
		}
	}

	tasks = new TaskDatabase('/api/missions/<%= @mission.id %>/tasks');
	console.log(tasks.get_all_tasks());

	const options = {
		'data' : tasks.get_tasks_hierarchy(),
		'pan': true,
		'zoom': true,
		'draggable': true,
		'createNode': function($node, data) {
			$node.append('<div class="add-button">+</div>');

			if(data.level !== 1){
				$node.append('<div class="delete-button">X</div>');
			}

			if (moment().diff(moment(data.created_at), 'weeks') < 1){
				$node.append('<div class="new-icon">NEW</div>')
			}
		}
	};


	let oc = $('#chart-container').orgchart(options);

	oc.$chart.on('nodedrop.orgchart', function(event) {
		console.log('drop');
		setTimeout('tasks.drop_hierarchy()', 100);
	});


	if (location.search !== '') {
		let task = location.search;
		task = task.replace( '?taskid=' , '' );

		$('#' + task).addClass("target_task");

	}

	$(document)
			.on('click', '.node', function() {
				tasks.set_selected_task_id($(this).attr('id'));
			})
			.on('click', '.title', function() {
				var deadline,
						$this = $(this).parent();

				let task_data = tasks.get_task_detail($(this).parent().attr('id'));

				$('#selected-node').val(task_data.title).data('node', $this);
				$('#DetailTask').modal('show');
				$('#datetimepickerDetailTaskDeadline').datetimepicker(
						{
							format: 'MM/DD/YYYY HH:mm',
						}
				);
				$('#DetailTaskID').text(task_data.id);
				$('#DetailTaskTitle').val(task_data.title);
				$('#DetailTaskDescription').val(task_data.description);

				deadline = task_data.deadline_at;
				if (deadline !== 'null') {
					$('#DetailTaskDeadline').val(moment(deadline).format('MM/DD/YYYY HH:mm'));
				}
				$('#DetailTaskStatus').val(task_data.status);
				$('#DetailTaskNotify').val(task_data.notify);
				if (task_data.notify === 'lod'){
					$('.ccby-license').addClass('ccby-active');
				}
				else {
					$('.ccby-license').removeClass('ccby-active');
				}


				let TaskParticipants = $('#TaskParticipants');
				TaskParticipants.empty();
				for (participant of task_data.participants){
					<% if user_signed_in? %>
					if (participant.id === <%= current_user.id %>){
						TaskParticipants.append('<li><span class="delete_task_participant" participant_id="' + participant.id + '">X</span>' + participant.name + '</li>');
					}
					else {
						TaskParticipants.append('<li>' + participant.name + '</li>');
					}
					<% else %>
					TaskParticipants.append('<li>' + participant.name + '</li>');
					<% end %>
				}


				{
					$('#TaskTags').empty();

					let task_id = task_data.id;
					let query = 'PREFIX mf-task: <http://lod.srmt.nitech.ac.jp/resource/MissionForest/tasks/>'
							+ 'PREFIX tags: <http://lod.srmt.nitech.ac.jp/tags/ontology#>'
							+ ''
							+ 'select ?tags where{'
							+ '  ?annotate tags:target mf-task:' + task_id + ' ;'
							+ '  tags:body ?tags.'
							+ '}';

					$.ajax({
						type: 'GET',
						url: 'http://lod.srmt.nitech.ac.jp/sparql/',
						data: {
							'query' : query,
							'format' : 'application/sparql-results+json',
							'default-graph-uri' : 'http://mf.srmt.nitech.ac.jp/tags/'
						},
						success: function(data) {
							console.log(data);
							for ( let x of data['results']['bindings'] ){
								let tag_name = x['tags']['value'];
								$('#TaskTags').append('<li><a href="' + tag_name + '">' + tag_name + '</a></li>');
							}

						}
					});
				}
			})
			.on('click', '.add-button', function() {
				var $this = $(this).parent();

				task_data = tasks.get_task_detail($(this).parent().attr('id'));

				$('#selected-node').val(task_data.title).data('node', $this);
				$('#AddTask').modal('show');
				$('#datetimepickerAddTaskDeadline').datetimepicker(
						{
							format: 'MM/DD/YYYY HH:mm',
						}
				);
				$('#AddTaskTitle').val('');
				$('#AddTaskDescription').val('')
			})
			.on('click', '.delete-button', function() {
				var $this = $(this).parent();

				console.log($(this).parent().attr('id'));
				task_data = tasks.get_task_detail($(this).parent().attr('id'));
				console.log(task_data);
				console.log(tasks.get_all_tasks());

				$('#selected-node').val(task_data.title).data('node', $this);
				$('#ConfirmDelete').modal('show');
				$('#DeleteTaskID').val(task_data.id);
				$('#DeleteTaskTitle').text(task_data.title);
			});

	<% if user_signed_in? %>
	$("#ToAddChild").click(function(){
		$('#AddTask').modal('show');
		$('#datetimepickerAddTaskDeadline').datetimepicker(
				{
					format: 'MM/DD/YYYY HH:mm',
				}
		);
		$('#AddTaskTitle').val('');
		$('#AddTaskDescription').val('')
	});
	$("#ToDeleteTask").click(function(){
		$('#ConfirmDelete').modal('show');
		$('#DeleteTaskID').val($('#DetailTaskID').val());
		$('#DeleteTaskTitle').text($('#DetailTaskTitle').val())
	});


	$("#DeleteTask").click(function(){
		task_id = tasks.get_selected_task_id();
		tasks.delete_task(task_id);
	});

	$("#ChangeDetail").click(function(){
		let task_id = tasks.get_selected_task_id(),
				title = $('#DetailTaskTitle').val(),
				description = $('#DetailTaskDescription').val(),
				deadline_at = date_format2rails($('#DetailTaskDeadline').val()),
				status = $('#DetailTaskStatus').val(),
				notify = $('#DetailTaskNotify').val();

		tasks.update_task_detail(task_id, title, description,
				deadline_at, status, notify)
	});


	$("#AddChild").click(function(){
		let parent_task_id = tasks.get_selected_task_id(),
				title = $('#AddTaskTitle').val(),
				description = $('#AddTaskDescription').val(),
				deadline_at = date_format2rails($('#AddTaskDeadline').val()),
				status = $('#AddTaskStatus').val(),
				notify = $('#AddTaskNotify').val();


		tasks.add_new_task(parent_task_id, title, description,
				deadline_at, status, notify)
	});

	$("#ToParticipate").click(function(){
		task_id = tasks.get_selected_task_id();
		tasks.participate_to_task(task_id)
	});


	$(".delete_admin").click(function(){
		var mission_id = <%= @mission.id %>;
		var admin_id = $(this).attr('admin_id');

		$.ajax({
			type: 'DELETE',
			url: '/api/missions/' + mission_id + '/delete_admin/' + admin_id,
			success: function(data){
				$('p[admin_id=' + admin_id + ']').remove();
			}});
	});


	$(".delete_mission_participant").click(function(){
		let mission_id = <%= @mission.id %>,
				participant_id = $(this).attr('participant_id');

		$.ajax({
			type: 'DELETE',
			url: '/api/missions/' + mission_id + '/delete_participant/' + participant_id,
			success: function(data){
				$('p[participant_id=' + participant_id + ']').remove();
			}});
	});


	$(document)
			.on('click', '.delete_task_participant', function() {
				let task_id = tasks.get_selected_task_id(),
						participant_id = $(this).attr('participant_id');

				$.ajax({
					type: 'DELETE',
					url: '/api/tasks/' + task_id + '/delete_participant/' + participant_id,
					success: function(data){
						$('span[participant_id=' + participant_id + ']').parent().remove();

						tasks.update_hierarchy(data.task_data.hierarchy);
						tasks.update_all_tasks(data.task_data.all_tasks);
					}});
			});
	<% end %>
</script>
