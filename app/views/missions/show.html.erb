<div class="main">
  <div class="container">

    <h2 id="mission-title" class="border-bottom border-white mb-4"><%= @mission.title %> <span class="h5">#<%= @mission.id %></span></h2>

    <% if user_signed_in? %>
      <% if @mission.admins.include?(current_user) || @mission.user == current_user %>
        <div class="row">
          <div class="col-md-3 col-sm-6 mb-4">
            <%= link_to 'ミッションを編集', "#", :id=> "DetailMissionModal", :style=>"width:100%;", :class => 'btn page-link text-dark d-inline-block' %>
          </div>
          <div class="col-md-3 col-sm-6 mb-4">
            <%= link_to "ミッションを削除", @mission, method: :delete, data: {confirm: "本当に削除しますか？"}, :style=>"width:100%;", :class => 'btn page-link text-dark d-inline-block' %>
          </div>
          <div class="col-md-3 col-sm-6 mb-4">
            <%= link_to '参加者を追加', mission_add_participant_path(@mission), :style=>"width:100%;", :class => 'btn page-link text-dark d-inline-block' %>
          </div>
          <div class="col-md-3 col-sm-6 mb-4">
            <%= link_to '管理者を追加', mission_add_admin_path(@mission), :style=>"width:100%;", :class => 'btn page-link text-dark d-inline-block' %>
          </div>
        </div>
      <% end %>
      <% if @mission.participants.include?(current_user) || @mission.user == current_user %>
        <%= link_to 'ミッションから抜ける?', "#", :id => "ConfirmDeleteMissionParticipantModal", :class => 'btn btn-primary mb-4' %>
      <%else %>
        <%= link_to 'ミッションに参加してみる', mission_add_me_path(@mission), :class => 'btn btn-primary mb-4' %>
      <% end %>
    <% end %>

    <div class="card mb-4">
      <div class="card-header">
        ミッション概要
      </div>
      <div class="card-body">
        <p id="mission-description" class="card-text"><%= @mission.description %></p>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header">
        ミッション管理者
      </div>
      <div class="card-body">
        <% @mission.admins.each do |admin| %>
          <p admin_id="<%= admin.id %>">
            <% if @mission.admins.include?(current_user) || @mission.user == current_user %>
              <span class="delete_admin" data-mission_admin_id="<%= admin.id %>">&times;</span>
            <% end %>
            <%= admin.name %>
          </p>
        <% end %>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header">
        ミッション参加者
      </div>
      <div class="card-body">
        <% @mission.participants.each do |participant| %>
          <p participant_id="<%= participant.id %>">
            <% if @mission.admins.include?(current_user) || @mission.user == current_user || current_user == participant %>
              <span class="delete_mission_participant" data-mission_participant_id="<%= participant.id %>">&times;</span>
            <% end %>
            <%= participant.name %>
          </p>
        <% end %>
      </div>
    </div>
    <div class="panel panel-info mb-4">
      <div class="panel-body tree">
        <div id="chart-container"></div>
        <!-- <input type="hidden" id="selected-node"> -->
      </div>
    </div>
  </div>
</div>


<%= render 'missions/modal/show/missions/detailmission' %>
<%= render 'missions/modal/show/tasks/addtask' %>
<%= render 'missions/modal/show/tasks/confirmdelete' %>
<%= render 'missions/modal/show/tasks/detailtask' %>

<script>
    const mission_id = <%= @mission.id %>;
    const lod = false;
    <% if user_signed_in? %>
    const user_signed_in = true;
    const user_id = <%= current_user.id %>;
    <% else %>
    const user_signed_in = false;
    const user_id = null;
    <% end %>

    const lod_graph_uri = 'http://mf.srmt.nitech.ac.jp/tags/';
    const sparql_endpoint = 'http://lod.srmt.nitech.ac.jp/sparql/';
    let tasks, mission;

    function date_format2rails(datestring){
        try {
            return moment(datestring,'MM/DD/YYYY HH:mm').utc().format();
        }
        catch {
            return null
        }
    }

    $(document)
        .on('click', '.node', function() {
            selected_task = $(this);
        })
        .on('click', '.title', function() {
            tasks.drawDetailTask($(this).parent().attr('id'));
        })
    <% if user_signed_in? %>

        .on('click', '.add-button', function() {
            tasks.drawAddTask($(this).parent().attr('id'));
        })
        .on('click', '.delete-button', function() {
            tasks.drawDeleteTask($(this).parent().attr('id'));
        })
        .on('click', '#ToAddChild', function () {
            tasks.drawAddTask($('#DetailTaskID').text());
        })
        .on('click', '#ToDeleteTask', function () {
            tasks.drawDeleteTask($('#DetailTaskID').text());
        })
        .on('click', '#DeleteTask', function(){
            let task = {
              'task_id' : tasks.get_selected_task_id()
            };
            App.mission.send_delete_task(task);
        })
        .on('click', '#ChangeDetail', function(){
            let task = {
              'task_id' : tasks.get_selected_task_id(),
              'title' : $('#DetailTaskTitle').val(),
              'description' : $('#DetailTaskDescription').val(),
              'deadline_at' : date_format2rails($('#DetailTaskDeadline').val()),
              'status' : $('#DetailTaskStatus').val(),
              'notify' : $('#DetailTaskNotify').val()
            };
            App.mission.send_update_task(task);
        })
        .on('click', '#AddChild', function(){
            let task = {
              'parent_task_id' : tasks.get_selected_task_id(),
              'title' : $('#AddTaskTitle').val(),
              'description' : $('#AddTaskDescription').val(),
              'deadline_at' : date_format2rails($('#AddTaskDeadline').val()),
              'status' : $('#AddTaskStatus').val(),
              'notify' : $('#AddTaskNotify').val()
            };
            App.mission.send_add_task(task);
        })
        .on('click', '#ToParticipate', function () {
            let participant = {
                'task_id' : tasks.get_selected_task_id(),
                'participant_id' : user_id
            };
            App.mission.send_add_task_participant(participant);
        })
        .on('click', '.delete_task_participant', function () {
            let participant = {
                'task_id' : tasks.get_selected_task_id(),
                'participant_id' : $(this).attr('data-task_participant_id')
            };
            App.mission.send_delete_task_participant(participant);
        })


        .on('click', '#DetailMissionModal', function () {
            mission.drawDeleteMission();
        })
        .on('click', '#ChangeMissionDetail', function () {
            let mission = {
                'mission_id' : mission_id,
                'title' : $('#DetailMissionTitle').val(),
                'description' : $('#DetailMissionDescription').val()
            };
            App.mission.send_delete_mission_participant(mission);
        })

        .on('click', '.delete_mission_participant',function () {
            let participant = {
                'participant_id' : $(this).attr('data-mission_participant_id')
            };
            App.mission.send_delete_mission_participant(participant);
        })
        .on('click','#ConfirmDeleteMissionParticipantModal',function () {
            mission.drawDeleteMissionParticipant();
        })
        .on('click', '#DeleteMissionParticipant', function () {
            let participant = {
                'participant_id' : user_id
            };
            App.mission.send_delete_mission_participant(participant);
        })


        .on('click', '.delete_admin', function () {
            let admin = {
                'admin_id': $(this).attr('data-mission_admin_id')
            };
            App.mission.send_delete_mission_admin(admin);
        })

    <% end %>
    ;
</script>
